<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문서관리 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
        }
        .sidebar, .toc-sidebar {
            background-color: #f4f4f4;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
        }
        .content {
            flex: 1;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        ul li {
            margin: 5px 0;
        }
        ul li a {
            text-decoration: none;
            color: #3498db;
            cursor: pointer;
        }
        ul li a:hover {
            text-decoration: underline;
        }
        #markdown-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        #markdown-container img {
            max-width: 100%;
            height: auto;
        }
        #markdown-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        #markdown-container table, 
        #markdown-container th, 
        #markdown-container td {
            border: 1px solid #ddd;
        }
        #markdown-container th, 
        #markdown-container td {
            padding: 8px;
            text-align: left;
        }
        .folder {
            font-weight: bold;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .folder:before {
            content: "▶";
            margin-right: 8px;
        }
        .folder.open:before {
            content: "▼";
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar, .toc-sidebar {
                display: none;
                width: 100%;
                position: absolute;
            }
            .sidebar.active, .toc-sidebar.active {
                display: block;
            }
            .toggle-button {
                display: block;
                background-color: #3498db;
                color: #fff;
                padding: 10px;
                text-align: center;
                cursor: pointer;
                user-select: none;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Version</h2>
        <select id="version-selector"></select>

        <h2>Language</h2>
        <select id="language-selector">
            <option value="en">English</option>
            <option value="ko">한글</option>
        </select>

        <h2>Documents</h2>
        <ul id="document-list"></ul>
    </div>

    <div class="content">
        <h1>문서 관리 테스트</h1>
        <div id="markdown-container">문서를 선택하세요</div>
    </div>

    <div class="toc-sidebar">
        <h2>Table of Contents</h2>
        <ul id="toc-list"></ul>
    </div>

    <script>
        const repoOwner = "OmniOneID";
        const repoName = "did-doc-architecture";
        const documentList = document.getElementById("document-list");
        const markdownContainer = document.getElementById("markdown-container");
        const tocList = document.getElementById("toc-list");
        const versionSelector = document.getElementById("version-selector");
        const languageSelector = document.getElementById("language-selector");

        let selectedLanguage = "en";

        async function fetchBranches() {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/branches`;
            const response = await fetch(url);
            return await response.json();
        }

        async function fetchMarkdownFiles(branch) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/git/trees/${branch}?recursive=1`;
            const response = await fetch(url);
            const data = await response.json();
            return data.tree.filter(item => {
                const isFolder = !item.path.includes(".");
                const isTargetLanguage = selectedLanguage === "ko" 
                    ? item.path.endsWith("_ko.md") 
                    : item.path.endsWith(".md") && !item.path.endsWith("_ko.md");
                return isFolder || isTargetLanguage;
            });
        }

        async function fetchFileContent(filePath) {
            const branch = versionSelector.value;
            const url = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/${filePath}`;
            const response = await fetch(url);
            return await response.text();
        }

        async function renderMarkdown(filePath) {
            const content = await fetchFileContent(filePath);
            const converter = new showdown.Converter();
            markdownContainer.innerHTML = converter.makeHtml(content);
            renderToc(content);
        }

        function renderToc(content) {
            tocList.innerHTML = "";
            const lines = content.split("\n");
            lines.forEach(line => {
                const match = line.match(/^(#{1,6})\s+(.*)/);
                if (match) {
                    const [, hashes, title] = match;
                    const li = document.createElement("li");
                    li.style.marginLeft = `${(hashes.length - 1) * 20}px`;
                    li.textContent = title;
                    tocList.appendChild(li);
                }
            });
        }

        async function populateDocumentList(branch) {
            const files = await fetchMarkdownFiles(branch);
            documentList.innerHTML = "";

            const folderMap = {};

            files.forEach(file => {
                const parts = file.path.split("/");
                const folder = parts.slice(0, -1).join("/");
                if (!folderMap[folder]) folderMap[folder] = [];
                folderMap[folder].push(file);
            });

            Object.keys(folderMap).forEach(folder => {
                const folderLi = document.createElement("li");
                folderLi.classList.add("folder");
                folderLi.textContent = folder || "Root";
                folderLi.addEventListener("click", () => {
                    const subList = folderLi.querySelector("ul");
                    const isOpen = subList.style.display === "block";
                    subList.style.display = isOpen ? "none" : "block";
                    folderLi.classList.toggle("open", !isOpen);
                });

                const subList = document.createElement("ul");
                subList.style.display = "none";

                folderMap[folder].forEach(file => {
                    const fileLi = document.createElement("li");
                    const fileLink = document.createElement("a");
                    fileLink.textContent = file.path.split("/").pop();
                    fileLink.href = "#";
                    fileLink.addEventListener("click", async (e) => {
                        e.preventDefault();
                        await renderMarkdown(file.path);
                    });
                    fileLi.appendChild(fileLink);
                    subList.appendChild(fileLi);
                });

                folderLi.appendChild(subList);
                documentList.appendChild(folderLi);
            });
        }

        async function init() {
            const branches = await fetchBranches();
            const defaultBranch = branches[0].name;
            versionSelector.innerHTML = branches.map(branch => `<option value="${branch.name}">${branch.name}</option>`).join("");
            versionSelector.value = defaultBranch;

            languageSelector.addEventListener("change", async () => {
                selectedLanguage = languageSelector.value;
                await populateDocumentList(defaultBranch);
            });

            await populateDocumentList(defaultBranch);
        }

        init();
    </script>
</body>
</html>
